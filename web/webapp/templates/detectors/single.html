{% extends "detectors/sidebar.html" %}
{% load mathfilters %}

{% block title %}
	{% if detector %}
		Detector: {{ detector.name }}
	{% else %}
		Detector: Not found
	{% endif %}
{% endblock title %}


{% block header %}
	{% if detector %}
		<h2>Detector: {{ detector.name }}</h2>
	{% else %}
		<h2>Detector - Not found</h2>
	{% endif %}
{% endblock header %}


{% block content %}

	{% if detector %}
		<section>
			<h2>Detector Info</h2>
			<dl>
				<dt>Name</dt>
					<dd>{{ detector.name }}</dd>
				<dt>Description</dt>
					<dd>{{ detector.description }}</dd>
				<dt>uuid</dt>
					<dd>{{ detector.uuid }}</dd>
				<br/>
				<dt>At Position</dt>
					<dd><a href="/positions/{{ detector.position.id }}/">{{ detector.position.name }}</a></dd>
			</dl>
		
		</section>

		<section>
			<h3>Chart of detections per day</h3>
			<canvas id="chart" width="600" height="{{ detections_per_week|mul:20 }}"></canvas>
		</section>
		
		<section>
			<h3>Table of detections per week</h3>
			<table>
				<thead>
				<tr><td>Week and year</td><td>Count</td></tr>
				</thead>
				{% for dpw in detections_per_week%}
					<tr><td>Week {{ dpw.week }}, {{ dpw.year }}</td><td>{{ dpw.count }}</td></tr>
				{% endfor %}
			</table>
		</section>
		
		
	{% else %}
		{# This should never be used as it should be a 404 #}
		<p>Error: Detector not found.</p>
	{% endif %}
{% endblock content %}

{% block foot %}
	<script>

		(function createChart() {
			let scripts = [
				'https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js',
				'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js'
			];
			// save all Promises as array
			let promises = [];
			scripts.forEach(function (url) {
				promises.push(loadScript(url));
			});

			Promise.all(promises)
				.then(function () {
					let ctx = document.getElementById("chart").getContext("2d");

					const data = {
						datasets: [{
							label: "Detection number per week",
							backgroundColor: "#79C8AE",
							borderColor: "#419076",
							data: [
								{% for dpw in detections_per_day %}
									{
										x: "{{ dpw.year }}-{{ dpw.month|stringformat:"02d" }}-{{ dpw.day|stringformat:"02d" }}",
										y: {{ dpw.count }}
									},
								{% endfor %}
							]
						}]
					};

					let chart = new Chart(ctx, {
						type: "bar",
						data: data,
						options: {
							responsive: true,
							interaction: {
								mode: 'nearest',
							},
							scales: {
								x: {
									type: 'time',
									//time: {
									//	unit: 'week'
									//},
									display: true,
									title: {
										display: true,
										text: 'Date'
									},
									ticks: {
										autoSkip: true,
										major: {
											enabled: true
										},
									}
								},
								y: {
									display: true,
									title: {
										display: true,
										text: 'Detections'
									},
								}
							},
							plugins: {
								legend: null,
							}
						}
					});
				}).catch(function (script) {
				console.log(script + ' failed to load');
			});
		})();
	</script>
{% endblock foot %}